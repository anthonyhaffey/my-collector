<script src="../libraries/tweetnacl.js"></script>
<script src="../libraries/tweetnacl-utils.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.min.js"></script>

<script>
  /*
    exemplar code
    var encryptedAES = CryptoJS.AES.encrypt("Message", "My Secret Passphrase");
    var decryptedBytes = CryptoJS.AES.decrypt(encryptedAES, "My Secret Passphrase");
    var plaintext = decryptedBytes.toString(CryptoJS.enc.Utf8);
    console.dir(plaintext);
  */
</script>

<nav class="navbar navbar-primary bg-white fixed-top fixed-top-2" id="sim_navbar">
  Howdy
</nav>
<br><br><br>

<br><br><br>
<div>
  <table>
    <tr>
      <td>
        Your Public Key
      </td>
      <td>
        Your encrypted private key
      </td>
    </tr>
    <tr>
      <td>
        <textarea class="control-form" id="public_key"></textarea>
      </td>
      <td>
        <textarea class="control-form" id="private_key"></textarea>
      </td>
    </tr>
  </table>
</div>



<!--
<div id="public_key"></div>
<div id="private_key"></div>
-->


<script>

function generate_keys(){

  //solution at https://medium.com/zinc_work/using-cryptography-tweetnacl-js-to-protect-user-data-intro-tips-tricks-a8e38e1818b5
  var keypair = nacl.box.keyPair();

  receiverPublicKey = nacl.util.encodeBase64(keypair.publicKey);
  receiverSecretKey = nacl.util.encodeBase64(keypair.secretKey)

  megaUberJson.keys = {};

  megaUberJson.keys.publicKey = receiverPublicKey;


  bootbox.prompt("In order to encrypt and decrypt your participants' data, we need a password. Make sure you will remember this password, if you forget it then any data that is encrypted will be lost forever.",function(result){
    bootbox.prompt("Let's type in the password one more time, just to be sure",function(result_2){
      if(result == result_2){

        var encryptedAES = CryptoJS.AES.encrypt(receiverSecretKey, result_2);
        var encryptedAES_string = encryptedAES.toString();
        var decrypted = CryptoJS.AES.decrypt(encryptedAES_string, result_2);
        var plaintext = decrypted.toString(CryptoJS.enc.Utf8);

        if(plaintext == receiverSecretKey){
          console.dir("all good");
          megaUberJson.keys.encrypted_private_key = encryptedAES_string;
        } else {
          bootbox.alert("Something went wrong with creating your encryption keys");
        }

      } else {
        bootbox.alert("Erm, your passwords didnt match, do you want to have another go?");
        //update this with the relevant code to clarify whether the user wants to have another go.

      }  
    })
  });

  //need to use synchronous key here to use the researchers password to encrypt the secretKey;


  function encrypt(receiverPublicKey, msgParams) {  //: string
    const ephemeralKeyPair = nacl.box.keyPair()  
    const pubKeyUInt8Array =  nacl.util.decodeBase64(receiverPublicKey)  
    const msgParamsUInt8Array = nacl.util.decodeUTF8(msgParams)  
    const nonce = nacl.randomBytes(nacl.box.nonceLength)
    const encryptedMessage = nacl.box(
      msgParamsUInt8Array,
      nonce,
      pubKeyUInt8Array,
      ephemeralKeyPair.secretKey
    )  
    return {
      ciphertext: nacl.util.encodeBase64(encryptedMessage),
      ephemPubKey: nacl.util.encodeBase64(ephemeralKeyPair.publicKey),
      nonce: nacl.util.encodeBase64(nonce),
      version: "x25519-xsalsa20-poly1305"
    }
    
  }
  /* Decrypt a message with a base64 encoded secretKey (privateKey) */
  function decrypt(receiverSecretKey, encryptedData) {  
    const receiverSecretKeyUint8Array = nacl.util.decodeBase64(
        receiverSecretKey
    )      
    const nonce = nacl.util.decodeBase64(encryptedData.nonce)      
    const ciphertext = nacl.util.decodeBase64(encryptedData.ciphertext)      
    const ephemPubKey = nacl.util.decodeBase64(encryptedData.ephemPubKey)      
    const decryptedMessage = nacl.box.open(
        ciphertext, 
        nonce,          
        ephemPubKey, 
        receiverSecretKeyUint8Array
    )
    return nacl.util.encodeUTF8(decryptedMessage)        
  }

  this_encrypted_message = encrypt(receiverPublicKey,"howdy");
  console.dir("this_encrypted_message");
  console.dir(this_encrypted_message);

  this_encrypted_message = JSON.stringify(this_encrypted_message);
  this_encrypted_message = JSON.parse(this_encrypted_message);

  bootbox.prompt("Let's quadruple check everything is working - if you put in your password you should see the message 'howdy', which has just been encrypted using your public key",function(user_password){
    var decrypted_private_key_obj = CryptoJS.AES.decrypt(megaUberJson.keys.encrypted_private_key, user_password);    
    var decrypted_private_key = decrypted_private_key_obj.toString(CryptoJS.enc.Utf8);
    this_decrypted_message = decrypt(decrypted_private_key,this_encrypted_message);
    alert(this_decrypted_message);
  });
  
}
</script>