<script src="../libraries/tweetnacl.js"></script>
<script src="../libraries/tweetnacl-utils.js"></script>

<div id="public_key"></div>
<div id="private_key"></div>
<script>

if(typeof(megaUberJson.keys) == "undefined"){

  //solution at https://medium.com/zinc_work/using-cryptography-tweetnacl-js-to-protect-user-data-intro-tips-tricks-a8e38e1818b5
  var keypair = nacl.box.keyPair();

  receiverPublicKey = nacl.util.encodeBase64(keypair.publicKey);
  receiverSecretKey = nacl.util.encodeBase64(keypair.secretKey)

  megaUberJson.keys.publicKey = receiverPublicKey;

  //need to use synchronous key here to use the researchers password to encrypt the secretKey;


  megaUberJson.keys.secretKey = receiverSecretKey;


  function encrypt(receiverPublicKey, msgParams) {  //: string
    const ephemeralKeyPair = nacl.box.keyPair()  
    const pubKeyUInt8Array =  nacl.util.decodeBase64(receiverPublicKey)  
    const msgParamsUInt8Array = nacl.util.decodeUTF8(msgParams)  
    const nonce = nacl.randomBytes(nacl.box.nonceLength)
    const encryptedMessage = nacl.box(
      msgParamsUInt8Array,
      nonce,        
      pubKeyUInt8Array,
      ephemeralKeyPair.secretKey
    )  
    return {    
      ciphertext: nacl.util.encodeBase64(encryptedMessage),    
      ephemPubKey: nacl.util.encodeBase64(ephemeralKeyPair.publicKey),
      nonce: nacl.util.encodeBase64(nonce),     
      version: "x25519-xsalsa20-poly1305"  
    }
    
  }
  /* Decrypt a message with a base64 encoded secretKey (privateKey) */
  function decrypt(receiverSecretKey, encryptedData) {  
    const receiverSecretKeyUint8Array = nacl.util.decodeBase64(
        receiverSecretKey
    )      
    const nonce = nacl.util.decodeBase64(encryptedData.nonce)      
    const ciphertext = nacl.util.decodeBase64(encryptedData.ciphertext)      
    const ephemPubKey = nacl.util.decodeBase64(encryptedData.ephemPubKey)      
    const decryptedMessage = nacl.box.open(
        ciphertext, 
        nonce,          
        ephemPubKey, 
        receiverSecretKeyUint8Array
    )
    return nacl.util.encodeUTF8(decryptedMessage)        
  }

  this_encrypted_message = encrypt(receiverPublicKey,"howdy");
  console.dir("this_encrypted_message");
  console.dir(this_encrypted_message);

  this_encrypted_message = JSON.stringify(this_encrypted_message);
  this_encrypted_message = JSON.parse(this_encrypted_message);
  this_decrypted_message = decrypt(receiverSecretKey,this_encrypted_message);
  }


</script>